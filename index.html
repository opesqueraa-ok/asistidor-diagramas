<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Diag-Assist v1.7.4 ‚Äî Matriz ‚Ä¢ Relaciones ‚Ä¢ Preponderancia</title>
<meta name="x-version" content="1.7.4"/>
<style>
  :root{
    --bg:#ffffff; --panel:#f7f7fb; --text:#1a2230; --muted:#687387; --accent:#2563eb;
    --border:#d8dbe6; --chip:#eef1f7; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
    --grid-dot:#e6e9f2;
    --rowAlt:#eef1f7;   /* zebra filas (ajusta si quieres) */
    --colAlt:#e8edf7;   /* zebra columnas */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:15px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial;
    -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
    overscroll-behavior:contain;
  }
  header{position:sticky;top:0;z-index:5;background:linear-gradient(#fff,rgba(255,255,255,.85));border-bottom:1px solid var(--border)}
  .wrap{max-width:1400px;margin:0 auto;padding:10px 14px}
  h1{margin:0 0 2px;font-size:18px} .sub{color:var(--muted);font-size:12px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tabbtn{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .tabbtn.active{background:var(--accent);border-color:var(--accent);color:#fff}
  /* Disposici√≥n vertical (Matriz arriba, tablero abajo) */
  .cols{display:flex;flex-direction:column;gap:14px}
  .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,button,select,textarea{border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:#fff;color:#000}
  button{cursor:pointer}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  table{border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:center}
  th.sticky{position:sticky;top:0;background:#fff;z-index:1}
  td.lock{background:#f3f4f8;color:#9aa3b2}
  .hint{font-size:12px;color:var(--muted)}
  #matrixHost{overflow:auto;display:flex;justify-content:center}
  /* Whiteboard */
  #boardWrap{
    position:relative;height:72vh;min-height:520px;
    border:1px solid var(--border);border-radius:14px;overflow:hidden;
    background:radial-gradient(var(--grid-dot) 1px, transparent 1px) 0 0/10px 10px #fff;
    touch-action:none;           /* üîë evita que el dedo haga scroll/zoom en el tablero */
  }
  #boardSVG{position:absolute;inset:0;touch-action:none}
  .node text{font-size:12px;pointer-events:none; fill:#000}
  .legend{display:flex;gap:10px;align-items:center;font-size:12px;margin-top:6px;flex-wrap:wrap}
  .legend .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);background:var(--chip);border-radius:999px;padding:4px 8px}
  .toolbar{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
  .hiddenRings { opacity:.15; transition:opacity .2s ease; }
  .node.dragging circle,.node.dragging ellipse{ stroke:#111; stroke-width:2.2 }
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 10px;font-size:12px;color:#000}
  #errBox{position:fixed;left:12px;bottom:12px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:8px 12px;border-radius:10px;font-size:12px;display:none;z-index:99}
  .optflag{font-size:11px;padding:2px 6px;border-radius:6px;border:1px solid var(--border);background:#fff}
  .compact table{font-size:12px}
  .compact th,.compact td{padding:5px}
  .mini{font-size:12px}
  .cfgbtn{padding:4px 6px;border-radius:8px}
  .chipbtn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .dot{width:12px;height:12px;border-radius:50%;border:1px solid #0002;display:inline-block}
  @media (max-width:560px){
    .tabbtn{padding:8px 10px;font-size:14px}
    input,button{padding:9px 10px}
    #boardWrap{min-height:420px}
  }
</style>
</head>
<body data-js="ready">
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <h1>Diag-Assist <span class="badge" id="versionBadge">v1.7.4</span></h1>
        <div class="sub">Matriz 8/4/0 ‚Üí Preponderancia (anillos) ‚Üí Relaciones. Basado en la gu√≠a de diagramaci√≥n.</div>
      </div>
      <div class="row">
        <button id="forceReload" title="Recargar forzando cach√©">Recargar v1.7.4</button>
      </div>
    </div>
    <div class="tabs">
      <button class="tabbtn active" data-tab="matriz">Matriz de Relaciones</button>
      <button class="tabbtn" data-tab="rel">Relaciones</button>
      <button class="tabbtn" data-tab="circ">Circulaciones</button>
      <button class="tabbtn" data-tab="burb">Diagrama de Burbujas</button>
      <button class="tabbtn" data-tab="bloq">Diagrama de Bloques</button>
      <button class="tabbtn" data-tab="ent">Entorno</button>
    </div>
  </div>
</header>

<div id="errBox"></div>

<main class="wrap">
  <div class="cols" id="colsRoot">
    <!-- Panel superior: controles -->
    <section class="card" id="leftPanel">
      <!-- ====== MATRIZ ====== -->
      <div class="tab tab-matriz">
        <h3>Matriz de relaciones (8 / 4 / 0)</h3>
        <div class="row">
          <input id="ambientesInput" placeholder="Ambientes separados por coma: Sala, Comedor, Cocina, Dorm 1, Dorm 2, S.S., Patio de servicio" style="width:100%"/>
        </div>
        <div class="toolbar">
          <button id="btnInsertTable">Insertar tabla</button>
          <button id="btnApplyPresets">Aplicar predeterminadas</button>
          <button id="btnClearMatrix">Limpiar matriz</button>
          <button id="btnCfgCustom">Config. predeter. personalizadas</button>
          <span class="optflag">Zebra visible</span>
        </div>
        <div class="toolbar">
          <button id="btnExport">Exportar (.diagassist)</button>
          <input type="file" id="fileImport" accept=".json,.diagassist" style="display:none"/>
          <button id="btnImport">Importar</button>
          <span class="hint">Lleva tu sesi√≥n a otro dispositivo.</span>
        </div>

        <div class="hint">Clic/tap en una celda para ciclar 0 ‚Üí 4 ‚Üí 8 (diagonal bloqueada y simetr√≠a autom√°tica). Las sumas de fila/columna deben coincidir.</div>

        <div class="space"></div>
        <div id="matrixHost"></div>

        <div class="space"></div>
        <div class="toolbar">
          <button id="btnPreponderancia">Calcular anillos (Œ£)</button>
          <button id="btnGenerarAmbientes">Generar ambientes en anillos</button>
          <button id="btnCopiarARelaciones" title="Pasa las burbujas al tab Relaciones">Copiar a ‚ÄúRelaciones‚Äù</button>
        </div>

        <div class="space"></div>
        <div class="toolbar mini">
          <span>Colorear zona (selecciona una burbuja y pulsa):</span>
          <span>
            <button id="zSocial">Social</button><button id="cfgSocial" class="cfgbtn" title="Cambiar color por defecto de Social">‚öô</button>
          </span>
          <span>
            <button id="zSemi">Semi-Privado</button><button id="cfgSemi" class="cfgbtn" title="Cambiar color por defecto de Semi-Privado">‚öô</button>
          </span>
          <span>
            <button id="zPrivada">Privada</button><button id="cfgPrivada" class="cfgbtn" title="Cambiar color por defecto de Privada">‚öô</button>
          </span>
          <span>
            <button id="zServicio">Servicio</button><button id="cfgServicio" class="cfgbtn" title="Cambiar color por defecto de Servicio">‚öô</button>
          </span>
          <button id="zCustom">Otro‚Ä¶ (nombre + color)</button>
          <span id="customZonesHost" style="display:flex;gap:6px;flex-wrap:wrap;"></span>
        </div>

        <div class="legend">
          <span class="chip" id="chipPriv"><svg width="14" height="14"><circle cx="7" cy="7" r="6"/></svg> Privada</span>
          <span class="chip" id="chipSemi"><svg width="14" height="14"><circle cx="7" cy="7" r="6"/></svg> Semi-Privado</span>
          <span class="chip" id="chipServ"><svg width="14" height="14"><circle cx="7" cy="7" r="6"/></svg> Servicio</span>
          <span class="chip" id="chipSoc"><svg width="14" height="14"><circle cx="7" cy="7" r="6"/></svg> Social</span>
        </div>
      </div>

      <!-- ====== RELACIONES ====== -->
      <div class="tab tab-rel" style="display:none">
        <h3>Relaciones (l√≠nea continua = 8; punteada = 4)</h3>
        <div class="toolbar">
          <button id="btnGenRelaciones">Generar relaciones desde matriz</button>
          <button id="btnClearRel">Limpiar l√≠neas</button>
          <label><input type="checkbox" id="chkHideRings"> Ocultar anillos</label>
          <label><input type="checkbox" id="chkSolid" checked> L√≠nea continua (8)</label>
          <label><input type="checkbox" id="chkDashed" checked> L√≠nea discontinua (4)</label>
        </div>
        <div class="hint">Aqu√≠ no hay flechas ni vest√≠bulos (eso es del diagrama de circulaciones).</div>
      </div>

      <!-- ====== CIRCULACIONES ====== -->
      <div class="tab tab-circ" style="display:none">
        <h3>Circulaciones</h3>
        <div class="toolbar">
          <button id="btnToArrows">Convertir relaciones en flechas</button>
          <button id="btnAddText">A√±adir cuadro de texto</button>
          <button id="btnPct">Colocar % en flechas</button>
          <button id="btnDirMode">Editar direcci√≥n de flechas: OFF</button>
        </div>
        <div class="hint">Con ‚ÄúEditar direcci√≥n‚Ä¶‚Äù activado, tap en una flecha invierte A‚ÜíB / B‚ÜíA. Con modo OFF, tap abre %.</div>
      </div>

      <!-- ====== BURBUJAS ====== -->
      <div class="tab tab-burb" style="display:none">
        <h3>Diagrama de Burbujas</h3>
        <div class="toolbar">
          <button id="btnToOvals">Convertir burbujas a √≥valos (m¬≤)</button>
          <button id="btnAddWindow">A√±adir ventana (V)</button>
          <button id="btnAddVest">A√±adir VEST (√≥valo)</button>
          <button id="btnDelBubble" title="Elimina la burbuja seleccionada">Eliminar burbuja</button>
        </div>
        <div class="hint">Asignar m¬≤ cambia el tama√±o (proporcional). Arrastra con el dedo la ‚ÄúV‚Äù y el ‚ÄúVEST‚Äù.</div>
      </div>

      <!-- ====== BLOQUES ====== -->
      <div class="tab tab-bloq" style="display:none">
        <h3>Diagrama de Bloques</h3>
        <div class="toolbar">
          <button id="btnAddRect">A√±adir bloque (rect√°ngulo, m¬≤)</button>
          <button id="btnAddCirc">A√±adir bloque (c√≠rculo, m¬≤)</button>
          <button id="btnAddRectBA">Rect√°ngulo (base√óaltura m)</button>
        </div>
      </div>

      <!-- ====== ENTORNO ====== -->
      <div class="tab tab-ent" style="display:none">
        <h3>Entorno</h3>
        <div class="toolbar">
          <button data-sym="NORTE" class="symBtn">Norte</button>
          <button data-sym="VISTAS" class="symBtn">Vistas</button>
          <button data-sym="VIENTOS" class="symBtn">Vientos</button>
          <button data-sym="SOL MA√ëANA" class="symBtn">Sol (ma√±ana)</button>
          <button data-sym="SOL TARDE" class="symBtn">Sol (tarde)</button>
          <button data-sym="PENDIENTE" class="symBtn">Pendiente</button>
          <button id="btnAmbientLayer">Capa ambiental</button>
          <button id="btnEntText">Texto + s√≠mbolo</button>
        </div>
        <div class="hint">Todos los s√≠mbolos son arrastrables.</div>
      </div>
    </section>

    <!-- Panel inferior: pizarra -->
    <section class="card" id="boardCard">
      <div id="boardWrap">
        <svg id="boardSVG"></svg>
      </div>
    </section>
  </div>
</main>

<script>
function showErr(e){
  try{ console.error(e); }catch{}
  var b = document.getElementById('errBox');
  if(!b) return;
  b.textContent = (e && e.message) ? e.message : String(e);
  b.style.display = 'block';
  setTimeout(function(){ b.style.display='none' }, 8000);
}

(function(){
  try{
    var VERSION = '1.7.4';

    // Recarga anti-cach√©
    var reloadBtn = document.getElementById('forceReload');
    if(reloadBtn){
      reloadBtn.addEventListener('click', function(){
        var url = new URL(window.location.href);
        url.searchParams.set('v', VERSION + '-' + Date.now());
        window.location.replace(url.toString());
      });
    }

    // ====== Estado global ======
    var S = {
      zonas: {},
      ambientes: [],
      matrix: {},
      sums: {},
      nodes: [],
      rings: [],
      view: 'matriz',
      relDraw: false,
      relOpts: { hideRings:false, showSolid:true, showDashed:true },
      flowPct: {},      // porcentaje por par
      flowDir: {},      // direcci√≥n por par: +1 (A‚ÜíB) o -1 (B‚ÜíA)
      freeText: [],
      ambientLayer: false,
      symbols: [],      // entorno
      customZones: []   // [{name,colorName,fill,stroke}]
    };

    // ===== Paletas / persistencia =====
    var ZONE_COLORS = {
      'Rojo':     {fill:'#fee2e2', stroke:'#ef4444'},
      'Azul':     {fill:'#e0f2fe', stroke:'#2563eb'},
      'Amarillo': {fill:'#fef9c3', stroke:'#f59e0b'},
      'Verde':    {fill:'#dcfce7', stroke:'#16a34a'},
      'Morado':   {fill:'#ede9fe', stroke:'#7c3aed'},
      'Rosado':   {fill:'#ffe4e6', stroke:'#f43f5e'},
      'Gris':     {fill:'#eef1f7', stroke:'#64748b'},
      'Caf√©':     {fill:'#ede3d7', stroke:'#7b5e57'},
      'Naranja':  {fill:'#ffedd5', stroke:'#ea580c'}
    };
    var LS_ZONE_STYLE   = 'diagassist.zoneStyles.v1';
    var LS_CUSTOM_ZONES = 'diagassist.userCustomZones.v1';
    var LS_PRESETS      = 'diagassist.customPresets.v1';
    var zoneStyle = loadJSON(LS_ZONE_STYLE) || {social:'Azul', semi:'Gris', privada:'Morado', servicio:'Naranja'};
    S.customZones = loadJSON(LS_CUSTOM_ZONES) || [];

    function loadJSON(key){ try{ return JSON.parse(localStorage.getItem(key)||''); }catch(_){ return null; } }
    function saveJSON(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(_){} }

    function applyChipColors(){
      [['chipPriv','privada'],['chipSemi','semi'],['chipServ','servicio'],['chipSoc','social']].forEach(function([id,key]){
        var chip = document.getElementById(id);
        var col = ZONE_COLORS[zoneStyle[key]||'Azul']||ZONE_COLORS['Azul'];
        var circle = chip && chip.querySelector('circle');
        if(circle){ circle.setAttribute('fill', col.fill); circle.setAttribute('stroke', col.stroke); }
      });
      renderCustomZoneChips();
    }
    function pickColorName(defaultName){
      var names = Object.keys(ZONE_COLORS);
      var choice = prompt('Elige un color ('+names.join(', ')+'):', defaultName||names[0]);
      if(choice==null) return null;
      choice = choice.trim();
      var found = names.find(function(n){ return n.toLowerCase()===choice.toLowerCase(); });
      return found || null;
    }

    // ====== Helpers DOM ======
    var $ = function(s){ return document.querySelector(s); };
    var el = function(t, attrs){ var x = document.createElement(t); if(attrs) Object.assign(x, attrs); return x; };
    var keyAB = function(a,b){ return a<b ? (a+'|'+b) : (b+'|'+a); };
    function setRel(a,b,val){ if(a===b) return; S.matrix[keyAB(a,b)] = val; }
    function getRel(a,b){ if(a===b) return 0; return S.matrix[keyAB(a,b)] != null ? S.matrix[keyAB(a,b)] : 0; }
    function normalizeKey(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }

    // ===== Tabs =====
    document.querySelectorAll('.tabbtn').forEach(function(btn){
      btn.addEventListener('click', function(){ switchTab(btn.dataset.tab); });
    });
    function switchTab(tab){
      document.querySelectorAll('.tabbtn').forEach(function(x){ x.classList.remove('active'); });
      var tb = document.querySelector('.tabbtn[data-tab="'+tab+'"]'); if(tb) tb.classList.add('active');
      document.querySelectorAll('.tab').forEach(function(x){ x.style.display='none'; });
      var t = document.querySelector('.tab-'+tab); if(t) t.style.display='';
      S.view = tab; drawBoard(S.view==='rel' && S.relDraw);
    }

    // ===== Predeterminadas base y configurables =====
    var PRESETS = [
      ['Cocina','Comedor',8],
      ['Patio de servicio','Cocina',8],
      ['Sala','Comedor',4],
      ['Dorm 1','S.S.',4], ['Dorm 2','S.S.',4]
    ];
    function loadCustom(){ return loadJSON(LS_PRESETS) || []; }
    function saveCustom(arr){ saveJSON(LS_PRESETS, arr||[]); }

    // ===== MATRIZ =====
    $('#btnInsertTable').addEventListener('click', function(){
      var txt = $('#ambientesInput').value.trim();
      if(!txt){ alert('Escribe los ambientes separados por coma'); return; }
      S.ambientes = txt.split(',').map(function(s){ return s.trim(); }).filter(Boolean);
      S.zonas = {};
      S.ambientes.forEach(function(n){
        var t = n.toLowerCase();
        S.zonas[n] = t.includes('dorm') ? 'privada'
                    : (t.includes('patio')||t.includes('cocina')||t.includes('lav')) ? 'servicio'
                    : 'social';
      });
      S.matrix = {}; S.flowPct={}; S.flowDir={};
      for(var i=0;i<S.ambientes.length;i++){
        for(var j=i+1;j<S.ambientes.length;j++){
          setRel(S.ambientes[i], S.ambientes[j], 0);
        }
      }
      renderMatrix();
      drawBoard();
      var colsRoot = document.getElementById('colsRoot');
      if(S.ambientes.length>=20){ colsRoot.classList.add('compact'); }
      applyChipColors();
    });
    $('#btnClearMatrix').addEventListener('click', function(){
      Object.keys(S.matrix).forEach(function(k){ S.matrix[k]=0; });
      renderMatrix(); drawBoard();
    });
    $('#btnApplyPresets').addEventListener('click', function(){
      var map = {}; S.ambientes.forEach(function(n){ map[normalizeKey(n)] = n; });
      PRESETS.concat(loadCustom()).forEach(function(x){
        var A = map[normalizeKey(x[0])], B = map[normalizeKey(x[1])], val = Number(x[2])||0;
        if(A && B) setRel(A,B,val);
      });
      renderMatrix();
    });
    $('#btnCfgCustom').addEventListener('click', function(){
      var cur = loadCustom();
      var txt = prompt('Agrega l√≠neas A|B|valor (0/4/8). Actual se reemplaza.\nEj.: Cocina|Sala|4', cur.map(function(t){return t.join('|')}).join('\n'));
      if(txt==null) return;
      var arr = [];
      txt.split(/\n+/).forEach(function(line){
        line=line.trim(); if(!line) return;
        var p = line.split('|'); if(p.length<3) return;
        arr.push([p[0].trim(), p[1].trim(), Number(p[2])||0]);
      });
      saveCustom(arr);
      alert('Guardado. Usa ‚ÄúAplicar predeterminadas‚Äù para aplicarlas.');
    });

    // ===== Exportar/Importar =====
    $('#btnExport').addEventListener('click', function(){
      var data = { version: VERSION, S: S, zoneStyle: zoneStyle, customZones: S.customZones };
      var blob = new Blob([JSON.stringify(data)], {type:'application/json'});
      var a = el('a'); a.href = URL.createObjectURL(blob); a.download = 'diagassist_'+Date.now()+'.diagassist';
      a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); }, 1000);
    });
    $('#btnImport').addEventListener('click', function(){ $('#fileImport').click(); });
    $('#fileImport').addEventListener('change', function(e){
      var f=e.target.files[0]; if(!f) return;
      var rd=new FileReader(); rd.onload=function(){
        try{
          var data=JSON.parse(rd.result); if(!data||!data.S) throw new Error('Archivo no v√°lido');
          S=data.S;
          if(data.zoneStyle)  { zoneStyle = data.zoneStyle; saveJSON(LS_ZONE_STYLE, zoneStyle); }
          if(data.customZones){ S.customZones = data.customZones; saveJSON(LS_CUSTOM_ZONES, S.customZones); }
          renderMatrix(); drawBoard(); applyChipColors(); alert('Importado ‚úì');
        }catch(err){ showErr(err); }
      }; rd.readAsText(f);
    });

    // ===== Render de matriz (zebra filas/columnas) =====
    function renderMatrix(){
      var host = $('#matrixHost'); host.innerHTML = '';
      if(S.ambientes.length===0){ host.innerHTML = '<div class="hint">Primero inserta la lista de ambientes.</div>'; return; }
      var tbl = el('table'), thead = el('thead'), hr = el('tr');
      hr.append(el('th',{textContent:'‚Äî',className:'sticky'}));
      S.ambientes.forEach(function(n, j){
        var th = el('th',{textContent:n,className:'sticky'});
        if(j%2===1) th.style.background='var(--colAlt)';
        hr.append(th);
      });
      hr.append(el('th',{textContent:'Œ£ fila',className:'sticky'})); thead.append(hr); tbl.append(thead);
      var tbody = el('tbody'); S.sums={};
      S.ambientes.forEach(function(a,i){
        var tr = el('tr'); var rowHead = el('th',{textContent:a,style:'position:sticky;left:0;background:#fff;z-index:1'});
        if(i%2===1) rowHead.style.background='var(--rowAlt)';
        tr.append(rowHead);
        var sum = 0;
        S.ambientes.forEach(function(b,j){
          var td = el('td');
          if(i%2===1) td.style.background='var(--rowAlt)';
          if(j%2===1) td.style.background='var(--colAlt)';
          if(i===j){ td.textContent='‚Äî'; td.className='lock'; tr.append(td); return; }
          var v = getRel(a,b); sum += v; td.textContent = String(v); td.style.cursor='pointer';
          td.addEventListener('click', function(){
            var cur = getRel(a,b), nxt = cur===0 ? 4 : (cur===4 ? 8 : 0);
            setRel(a,b,nxt); renderMatrix();
          }, {passive:true});
          tr.append(td);
        });
        S.sums[a]=sum; var tdSum = el('td',{textContent:String(sum)});
        if(i%2===1) tdSum.style.background='var(--rowAlt)';
        tr.append(tdSum); tbody.append(tr);
      });
      var trS = el('tr'); trS.append(el('th',{textContent:'Œ£ col'}));
      var ok = true;
      S.ambientes.forEach(function(b,j){
        var s=0; S.ambientes.forEach(function(a,i){ if(i!==j) s += getRel(a,b); });
        var td=el('td',{textContent:String(s)});
        if(j%2===1) td.style.background='var(--colAlt)';
        trS.append(td);
        if(s!==S.sums[b]) ok=false;
      });
      trS.append(el('td',{innerHTML: ok ? '<span class="ok">‚úì OK</span>' : '<span class="err">‚ö† Revisar</span>'})); tbody.append(trS);
      tbl.append(tbody); host.append(tbl);
    }

    // ===== Preponderancia (anillos) =====
    function computeRings(){
      S.sums={}; S.ambientes.forEach(function(a){ var s=0; S.ambientes.forEach(function(b){ if(a!==b) s+=getRel(a,b); }); S.sums[a]=s; });
      var uniq = Array.from(new Set(Object.values(S.sums))).sort(function(a,b){return b-a});
      var svg = $('#boardSVG'), W = svg.parentElement.clientWidth, H = svg.parentElement.clientHeight;
      var RMAX = Math.floor(Math.min(W,H)/2) - 40;
      var step = Math.max(48, Math.floor(RMAX / (uniq.length+0.5)));
      S.rings = uniq.map(function(sum,idx){ return {sum:sum, r: step + idx*step}; });
    }
    $('#btnPreponderancia').addEventListener('click', function(){
      if(S.ambientes.length===0){ alert('Primero crea la matriz.'); return; }
      computeRings(); S.nodes=[]; drawBoard();
    });
    $('#btnGenerarAmbientes').addEventListener('click', function(){
      if(!S.rings.length) computeRings();
      var svg = $('#boardSVG'), W=svg.parentElement.clientWidth, H=svg.parentElement.clientHeight, cx=W/2, cy=H/2;
      S.nodes=[]; var groups={};
      S.ambientes.forEach(function(n){ var s=S.sums[n]||0; (groups[s]=groups[s]||[]).push(n); });
      Object.keys(groups).forEach(function(sum){
        var ring=S.rings.find(function(r){return r.sum==sum}); var list=groups[sum];
        list.forEach(function(name,idx){
          var angle=(idx/list.length)*Math.PI*2, x=cx+ring.r*Math.cos(angle), y=cy+ring.r*Math.sin(angle);
          S.nodes.push({name:name,x:x,y:y,ring:ring.r,zone:S.zonas[name]||'social'});
        });
      });
      drawBoard();
    });
    $('#btnCopiarARelaciones').addEventListener('click', function(){ switchTab('rel'); });

    // ===== Relaciones =====
    $('#btnGenRelaciones').addEventListener('click', function(){ S.relDraw=true; switchTab('rel'); });
    $('#btnClearRel').addEventListener('click', function(){ S.relDraw=false; drawBoard(false); });
    $('#chkHideRings').addEventListener('change', function(e){ S.relOpts.hideRings=e.target.checked; drawBoard(S.relDraw); });
    $('#chkSolid').addEventListener('change', function(e){ S.relOpts.showSolid=e.target.checked; drawBoard(S.relDraw); });
    $('#chkDashed').addEventListener('change', function(e){ S.relOpts.showDashed=e.target.checked; drawBoard(S.relDraw); });

    // ===== Circulaciones =====
    $('#btnToArrows').addEventListener('click', function(){ switchTab('circ'); });
    $('#btnAddText').addEventListener('click', function(){
      var txt = prompt('Texto:'); if(!txt) return;
      var svg=$('#boardSVG'), W=svg.clientWidth, H=svg.clientHeight, x=W/2, y=30+Math.random()*60;
      S.freeText.push({x:x,y:y,txt:txt,fill:'#111'}); drawBoard(S.relDraw);
    });
    $('#btnPct').addEventListener('click', function(){
      alert('Toca una flecha para asignar/editar su %; el texto se orienta paralelo a la flecha y en su punto medio.');
    });
    var dirMode=false;
    $('#btnDirMode').addEventListener('click', function(){
      dirMode=!dirMode; this.textContent='Editar direcci√≥n de flechas: '+(dirMode?'ON':'OFF');
    });

    // ===== Burbujas =====
    $('#btnToOvals').addEventListener('click', function(){
      if(!S.nodes.length){ alert('Genera primero las burbujas.'); return; }
      var maxA=0, areas={};
      S.nodes.forEach(function(n){
        var v = prompt('√Årea en m¬≤ para "'+n.name+'":', n.area||''); if(v==null) return;
        var a=Math.max(1, Number(v)||1); areas[n.name]=a; if(a>maxA) maxA=a;
      });
      var maxR=42, k = maxR / Math.sqrt(maxA||1);
      S.nodes.forEach(function(n){
        var a=areas[n.name]||1; n.area=a; var base=Math.sqrt(a)*k; n.rx=base*1.2; n.ry=base*0.9;
      });
      switchTab('burb');
    });
    $('#btnAddWindow').addEventListener('click', function(){
      var svg=$('#boardSVG'), W=svg.clientWidth, H=svg.clientHeight, x=W/2+(Math.random()*60-30), y=H/2+(Math.random()*60-30);
      S.freeText.push({x:x,y:y,txt:'V',fill:'#111'}); drawBoard();
    });
    $('#btnAddVest').addEventListener('click', function(){
      var svg=$('#boardSVG'), W=svg.clientWidth, H=svg.clientHeight, x=W/2, y=H/2;
      S.nodes.push({name:'VEST',x:x,y:y,rx:26,ry:18,lock:false,zone:'servicio'}); switchTab('burb');
    });
    $('#btnDelBubble').addEventListener('click', function(){
      if(!selectedNode){ alert('Selecciona primero una burbuja'); return; }
      var i = S.nodes.indexOf(selectedNode); if(i>=0){ S.nodes.splice(i,1); selectedNode=null; drawBoard(S.view==='rel'&&S.relDraw); }
    });

    // ===== Entorno =====
    document.querySelectorAll('.symBtn').forEach(function(b){
      b.addEventListener('click', function(){
        var label=b.getAttribute('data-sym'); var svg=$('#boardSVG'), W=svg.clientWidth, H=svg.clientHeight;
        var x=30+Math.random()*80, y=40+Math.random()*80; S.symbols.push({x:x,y:y,txt:label,w:84,h:36});
        switchTab('ent'); drawBoard();
      });
    });
    $('#btnAmbientLayer').addEventListener('click', function(){ S.ambientLayer=!S.ambientLayer; drawBoard(); });
    $('#btnEntText').addEventListener('click', function(){
      var txt = prompt('Texto:'); if(!txt) return;
      var svg=$('#boardSVG'), x=svg.clientWidth/2, y=svg.clientHeight-20; S.symbols.push({x:x,y:y,txt:txt,w:100,h:40});
      drawBoard();
    });

    // ===== Zonas (‚öô + Otro + personalizados visibles) =====
    var selectedNode=null;
    document.addEventListener('pointerdown', function(e){
      var g = e.target.closest('.node');
      if(!g){ selectedNode=null; return; }
      var label = (g.querySelector('text')||{}).textContent;
      selectedNode = S.nodes.find(function(n){ return n.name===label; }) || null;
    }, {passive:true});

    function styleForZoneKey(key){
      var name = zoneStyle[key] || 'Azul';
      return ZONE_COLORS[name] || ZONE_COLORS['Azul'];
    }
    function setZone(z, style){
      if(!selectedNode){ alert('Primero selecciona una burbuja'); return; }
      selectedNode.zone=z;
      var st = style || styleForZoneKey(z);
      selectedNode.fill = st.fill;
      selectedNode.stroke = st.stroke;
      drawBoard(S.view==='rel'&&S.relDraw);
    }

    $('#zSocial').addEventListener('click', function(){ setZone('social'); });
    $('#zSemi').addEventListener('click', function(){ setZone('semi'); });
    $('#zPrivada').addEventListener('click', function(){ setZone('privada'); });
    $('#zServicio').addEventListener('click', function(){ setZone('servicio'); });

    function configureZoneDefault(which){
      var current = zoneStyle[which] || 'Azul';
      var pick = pickColorName(current);
      if(!pick) return;
      zoneStyle[which] = pick; saveJSON(LS_ZONE_STYLE, zoneStyle); applyChipColors();
      if(selectedNode && selectedNode.zone===which){
        var st = ZONE_COLORS[pick];
        selectedNode.fill = st.fill; selectedNode.stroke = st.stroke; drawBoard(S.view==='rel'&&S.relDraw);
      }
    }
    $('#cfgSocial').addEventListener('click', function(){ configureZoneDefault('social'); });
    $('#cfgSemi').addEventListener('click', function(){ configureZoneDefault('semi'); });
    $('#cfgPrivada').addEventListener('click', function(){ configureZoneDefault('privada'); });
    $('#cfgServicio').addEventListener('click', function(){ configureZoneDefault('servicio'); });

    $('#zCustom').addEventListener('click', function(){
      if(!selectedNode){ alert('Selecciona una burbuja'); return; }
      var nombre = prompt('Nombre de la zona personalizada:' , '');
      if(nombre==null || !nombre.trim()) return;
      var pick = pickColorName('Azul'); if(!pick) return;
      var st = ZONE_COLORS[pick];
      selectedNode.zone = 'custom:'+nombre.trim();
      selectedNode.customName = nombre.trim();
      selectedNode.fill = st.fill; selectedNode.stroke = st.stroke;
      var idx = S.customZones.findIndex(function(z){ return z.name.toLowerCase()===nombre.trim().toLowerCase(); });
      var entry = {name:nombre.trim(), colorName:pick, fill:st.fill, stroke:st.stroke};
      if(idx>=0) S.customZones[idx]=entry; else S.customZones.push(entry);
      saveJSON(LS_CUSTOM_ZONES, S.customZones);
      renderCustomZoneChips();
      drawBoard(S.view==='rel'&&S.relDraw);
    });

    function renderCustomZoneChips(){
      var host = document.getElementById('customZonesHost');
      host.innerHTML='';
      if(!S.customZones.length) return;
      S.customZones.forEach(function(cz){
        var btn = document.createElement('button');
        btn.className='chipbtn'; btn.title='Aplicar zona personalizada';
        var dot = document.createElement('span'); dot.className='dot'; dot.style.background=cz.fill; dot.style.borderColor=cz.stroke;
        btn.appendChild(dot); btn.appendChild(document.createTextNode(' '+cz.name));
        btn.addEventListener('click', function(){
          if(!selectedNode){ alert('Selecciona una burbuja'); return; }
          setZone('custom:'+cz.name, {fill:cz.fill, stroke:cz.stroke});
          selectedNode.customName = cz.name;
        });
        host.appendChild(btn);
      });
    }

    // ===== Geometr√≠a flechas =====
    function edgePoint(ax,ay,bx,by,node){
      var dx=bx-ax, dy=by-ay;
      var angle=Math.atan2(dy,dx);
      var rx = node.rx ? node.rx : 16;
      var ry = node.ry ? node.ry : 16;
      var ex = ax + rx * Math.cos(angle);
      var ey = ay + ry * Math.sin(angle);
      return {x:ex,y:ey,angle:angle};
    }

    // ====== DRAG universal (Pointer Events) ======
    function makeDraggableSVGNode(svg, g, n, onmove){
      g.style.touchAction = 'none';
      var dragging=false, pointerId=null;

      g.addEventListener('pointerdown', function(ev){
        if(n.lock) return;
        dragging=true; pointerId=ev.pointerId; g.setPointerCapture(pointerId); g.classList.add('dragging');
        ev.preventDefault();
      }, {passive:false});

      g.addEventListener('pointermove', function(ev){
        if(!dragging) return;
        var p=svg.getBoundingClientRect(); var x=ev.clientX-p.left, y=ev.clientY-p.top;
        onmove(x,y,ev);
        ev.preventDefault();
      }, {passive:false});

      function end(){ if(!dragging) return; dragging=false; try{ g.releasePointerCapture(pointerId);}catch(_){} g.classList.remove('dragging'); }
      g.addEventListener('pointerup', end, {passive:true});
      g.addEventListener('pointercancel', end, {passive:true});
      g.addEventListener('pointerleave', end, {passive:true});
    }

    function makeDraggableText(svg, tt, item){
      tt.style.touchAction='none';
      var dragging=false, pointerId=null, off=[0,0];
      tt.addEventListener('pointerdown', function(ev){
        dragging=true; pointerId=ev.pointerId; tt.setPointerCapture(pointerId);
        var bb=tt.getBBox(); off=[ev.clientX-bb.x, ev.clientY-bb.y]; ev.preventDefault();
      }, {passive:false});
      tt.addEventListener('pointermove', function(ev){
        if(!dragging) return;
        var p=svg.getBoundingClientRect(); item.x=ev.clientX-p.left-off[0]; item.y=ev.clientY-p.top-off[1];
        tt.setAttribute('x',item.x); tt.setAttribute('y',item.y); ev.preventDefault();
      }, {passive:false});
      function end(){ if(!dragging) return; dragging=false; try{ tt.releasePointerCapture(pointerId);}catch(_){} }
      tt.addEventListener('pointerup', end, {passive:true});
      tt.addEventListener('pointercancel', end, {passive:true});
      tt.addEventListener('pointerleave', end, {passive:true});
    }

    function makeDraggableRect(svg, inv, s){
      inv.style.touchAction='none';
      var dragging=false, pointerId=null, off=[0,0];
      inv.addEventListener('pointerdown', function(ev){
        dragging=true; pointerId=ev.pointerId; inv.setPointerCapture(pointerId);
        off=[ev.offsetX, ev.offsetY]; ev.preventDefault();
      }, {passive:false});
      inv.addEventListener('pointermove', function(ev){
        if(!dragging) return;
        var p=svg.getBoundingClientRect();
        s.x = ev.clientX - p.left - s.w/2 + off[0];
        s.y = ev.clientY - p.top  - s.h/2 + off[1];
        drawBoard(S.view==='rel'&&S.relDraw);
        ev.preventDefault();
      }, {passive:false});
      function end(){ if(!dragging) return; dragging=false; try{ inv.releasePointerCapture(pointerId);}catch(_){} }
      inv.addEventListener('pointerup', end, {passive:true});
      inv.addEventListener('pointercancel', end, {passive:true});
      inv.addEventListener('pointerleave', end, {passive:true});
    }

    // ===== Dibujo principal =====
    function drawBoard(drawEdges){
      var svg = document.getElementById('boardSVG'); svg.innerHTML='';
      var W = svg.parentElement.clientWidth, H = svg.parentElement.clientHeight;
      svg.setAttribute('width', W); svg.setAttribute('height', H);
      var cx=W/2, cy=H/2;

      if(S.ambientLayer){
        var rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x',10); rect.setAttribute('y',10);
        rect.setAttribute('width',W-20); rect.setAttribute('height',H-20);
        rect.setAttribute('fill','rgba(0,160,255,.05)'); rect.setAttribute('stroke','#00a0ff');
        rect.setAttribute('stroke-dasharray','8 8'); svg.appendChild(rect);
      }

      var gRings=document.createElementNS('http://www.w3.org/2000/svg','g');
      if(S.view==='rel' && S.relOpts.hideRings) gRings.classList.add('hiddenRings');
      svg.appendChild(gRings);

      if((S.view==='matriz'||S.view==='rel'||S.view==='circ') && S.rings.length){
        S.rings.forEach(function(r){
          var c=document.createElementNS('http://www.w3.org/2000/svg','circle');
          c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',r.r);
          c.setAttribute('fill','none'); c.setAttribute('stroke','#bcd0ff'); c.setAttribute('stroke-width','1.2'); gRings.appendChild(c);
          var t=document.createElementNS('http://www.w3.org/2000/svg','text');
          t.setAttribute('x',cx+r.r+6); t.setAttribute('y',cy-6); t.setAttribute('fill','#5f6b86'); t.textContent='Œ£ = '+r.sum; gRings.appendChild(t);
        });
      }

      var defs=document.createElementNS('http://www.w3.org/2000/svg','defs'); svg.appendChild(defs);
      if(S.view==='circ'){
        var mk=document.createElementNS('http://www.w3.org/2000/svg','marker');
        mk.setAttribute('id','arrow'); mk.setAttribute('markerWidth','12'); mk.setAttribute('markerHeight','12');
        mk.setAttribute('refX','11'); mk.setAttribute('refY','3'); mk.setAttribute('orient','auto');
        mk.innerHTML='<path d="M0,0 L11,3 L0,6 Z" fill="#1f2937"/>'; defs.appendChild(mk);
      }

      var gEdges=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(gEdges);
      if(S.nodes.length){
        for(var i=0;i<S.nodes.length;i++){
          for(var j=i+1;j<S.nodes.length;j++){
            var a=S.nodes[i], b=S.nodes[j], val=getRel(a.name,b.name);
            if(!val) continue;

            if(S.view==='rel' && drawEdges){
              var line=document.createElementNS('http://www.w3.org/2000/svg','line');
              line.setAttribute('x1', a.x); line.setAttribute('y1', a.y);
              line.setAttribute('x2', b.x); line.setAttribute('y2', b.y);
              line.setAttribute('stroke','#1f2937'); line.setAttribute('stroke-width','1.8');
              if(val===4 && S.relOpts.showDashed) line.setAttribute('stroke-dasharray','6 6');
              if(val===8 && !S.relOpts.showSolid) continue;
              gEdges.appendChild(line);
            }

            if(S.view==='circ'){
              var k=keyAB(a.name,b.name);
              if(S.flowDir[k]==null) S.flowDir[k]=+1;
              var from=a, to=b;
              if(S.flowDir[k]<0){ from=b; to=a; }
              var A = edgePoint(from.x,from.y,to.x,to.y,from);
              var B = edgePoint(to.x,to.y,from.x,from.y,to);

              var line2=document.createElementNS('http://www.w3.org/2000/svg','line');
              line2.setAttribute('x1', A.x); line2.setAttribute('y1', A.y);
              line2.setAttribute('x2', B.x); line2.setAttribute('y2', B.y);
              line2.setAttribute('stroke','#1f2937'); line2.setAttribute('stroke-width','1.8');
              line2.setAttribute('marker-end','url(#arrow)');
              gEdges.appendChild(line2);

              var pct=S.flowPct[k];
              if(pct!=null){
                var mx=(A.x+B.x)/2, my=(A.y+B.y)/2, ang=Math.atan2(B.y-A.y,B.x-A.x)*180/Math.PI;
                var lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
                lbl.setAttribute('x',mx); lbl.setAttribute('y',my);
                lbl.setAttribute('fill','#1f2937'); lbl.setAttribute('font-size','12');
                lbl.setAttribute('text-anchor','middle');
                lbl.setAttribute('transform','rotate('+ang+' '+mx+' '+my+')');
                lbl.textContent=pct+'%'; gEdges.appendChild(lbl);
              }

              line2.addEventListener('pointerup', (function(k){
                return function(ev){
                  if(dirMode){
                    S.flowDir[k] = (S.flowDir[k]||1)*(-1); drawBoard(drawEdges); return;
                  }
                  var v = prompt('Porcentaje de flujo (0-100):', (S.flowPct[k] != null ? S.flowPct[k] : ''));
                  if(v==null) return; var n=Math.max(0,Math.min(100, Number(v)||0)); S.flowPct[k]=n; drawBoard(drawEdges);
                }
              })(k), {passive:true});
            }
          }
        }
      }

      // Nodos (draggable con pointer events)
      var gNodes=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(gNodes);
      S.nodes.forEach(function(n){
        var g=document.createElementNS('http://www.w3.org/2000/svg','g');
        g.classList.add('node');
        g.setAttribute('transform','translate('+n.x+','+n.y+')');
        var fill=n.fill || (styleForZoneKey(n.zone||'social').fill);
        var stroke=n.stroke || (styleForZoneKey(n.zone||'social').stroke);
        var mainShape;
        if(n.rx && n.ry){
          mainShape=document.createElementNS('http://www.w3.org/2000/svg','ellipse');
          mainShape.setAttribute('rx',n.rx); mainShape.setAttribute('ry',n.ry);
        }else{
          mainShape=document.createElementNS('http://www.w3.org/2000/svg','circle'); mainShape.setAttribute('r','18'); /* un poquito m√°s grande para dedo */
        }
        mainShape.setAttribute('fill',fill); mainShape.setAttribute('stroke',stroke); mainShape.setAttribute('stroke-width','1.6');
        g.appendChild(mainShape);

        var t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('text-anchor','middle'); t.setAttribute('dy','.35em'); t.textContent=n.name; g.appendChild(t);

        makeDraggableSVGNode(svg, g, n, function(x,y){
          if(['matriz','rel','circ'].includes(S.view)){
            var ang=Math.atan2(y-cy,x-cx); n.x = cx + (n.ring||16)*Math.cos(ang); n.y = cy + (n.ring||16)*Math.sin(ang);
          }else{ n.x=x; n.y=y; }
          g.setAttribute('transform','translate('+n.x+','+n.y+')');
          drawBoard(drawEdges);
        });

        gNodes.appendChild(g);
      });

      // Textos sueltos arrastrables
      if(S.freeText.length){
        var gT=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(gT);
        S.freeText.forEach(function(item){
          var tt=document.createElementNS('http://www.w3.org/2000/svg','text');
          tt.setAttribute('x',item.x); tt.setAttribute('y',item.y);
          tt.setAttribute('fill',item.fill||'#111'); tt.setAttribute('font-size','14'); tt.setAttribute('text-anchor','middle'); tt.textContent=item.txt;
          makeDraggableText(svg, tt, item);
          gT.appendChild(tt);
        });
      }

      // S√≠mbolos/Texto con √°rea invisible para arrastrar
      if(S.symbols.length){
        var gS=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(gS);
        S.symbols.forEach(function(s){
          var grp=document.createElementNS('http://www.w3.org/2000/svg','g'); gS.appendChild(grp);
          var inv=document.createElementNS('http://www.w3.org/2000/svg','rect');
          inv.setAttribute('x',s.x- s.w/2); inv.setAttribute('y',s.y- s.h/2); inv.setAttribute('width',s.w); inv.setAttribute('height',s.h);
          inv.setAttribute('fill','transparent'); inv.style.cursor='move'; grp.appendChild(inv);
          var tt=document.createElementNS('http://www.w3.org/2000/svg','text');
          tt.setAttribute('x',s.x); tt.setAttribute('y',s.y+4); tt.setAttribute('text-anchor','middle'); tt.setAttribute('fill','#0a4'); tt.textContent=s.txt; grp.appendChild(tt);
          makeDraggableRect(svg, inv, s);
        });
      }
    }

    // ====== Chips personalizados ======
    function renderCustomZoneChips(){
      var host = document.getElementById('customZonesHost');
      host.innerHTML='';
      if(!S.customZones.length) return;
      S.customZones.forEach(function(cz){
        var btn = document.createElement('button');
        btn.className='chipbtn'; btn.title='Aplicar zona personalizada';
        var dot = document.createElement('span'); dot.className='dot'; dot.style.background=cz.fill; dot.style.borderColor=cz.stroke;
        btn.appendChild(dot); btn.appendChild(document.createTextNode(' '+cz.name));
        btn.addEventListener('click', function(){
          if(!selectedNode){ alert('Selecciona una burbuja'); return; }
          setZone('custom:'+cz.name, {fill:cz.fill, stroke:cz.stroke});
          selectedNode.customName = cz.name;
        });
        host.appendChild(btn);
      });
    }

    applyChipColors();
    renderCustomZoneChips();
    drawBoard(false);

    // ===== selecci√≥n de nodo (para colorear) =====
    var selectedNode=null;
    document.addEventListener('pointerdown', function(e){
      var g = e.target.closest('.node');
      if(!g){ selectedNode=null; return; }
      var label = (g.querySelector('text')||{}).textContent;
      selectedNode = S.nodes.find(function(n){ return n.name===label; }) || null;
    }, {passive:true});

  }catch(e){ showErr(e); }
})(); // IIFE
</script>
</body>
</html>
